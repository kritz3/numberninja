<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Number Ninja</title>
  <style>
    :root {
      --bg: #0b1220;
      --card: #111a2e;
      --text: #eaf0ff;
      --muted: #9fb0d0;
      --good: #2dd4bf;
      --bad: #fb7185;
      --warn: #fbbf24;
      --coin: #fcd34d;
      --btn: #1f2a44;
      --btnHover: #283658;
      --shadow: rgba(0,0,0,0.35);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% 10%, #1a2a55 0%, var(--bg) 55%);
      color: var(--text);
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 16px;
    }

    .wrap {
      width: min(720px, 100%);
      display: grid;
      gap: 14px;
    }

    .topbar {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .pill {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
      padding: 12px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 10px 30px var(--shadow);
      backdrop-filter: blur(6px);
    }
    .pill .label { color: var(--muted); font-size: 12px; }
    .pill .value { font-size: 18px; font-weight: 700; }

    .card {
      background: rgba(17,26,46,0.82);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 14px 40px var(--shadow);
      backdrop-filter: blur(8px);
    }

    .question {
      text-align: center;
      font-size: clamp(34px, 7vw, 54px);
      font-weight: 900;
      letter-spacing: 0.5px;
      margin: 8px 0 14px;
    }

    .sub {
      text-align: center;
      color: var(--muted);
      margin-top: -4px;
      margin-bottom: 14px;
      font-size: 14px;
      min-height: 20px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    button.choice, button.primary, button.secondary {
      appearance: none;
      border: 1px solid rgba(255,255,255,0.12);
      background: var(--btn);
      color: var(--text);
      border-radius: 14px;
      padding: 14px 14px;
      font-size: 20px;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 10px 22px rgba(0,0,0,0.25);
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    button.choice:active, button.primary:active, button.secondary:active { transform: scale(0.99); }
    button.choice:hover, button.primary:hover, button.secondary:hover { background: var(--btnHover); }

    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 12px;
    }
    button.primary {
      background: rgba(45,212,191,0.18);
      border-color: rgba(45,212,191,0.35);
    }
    button.primary:hover { background: rgba(45,212,191,0.25); }

    button.secondary {
      background: rgba(159,176,208,0.12);
      border-color: rgba(159,176,208,0.25);
      font-size: 16px;
      padding: 12px 14px;
    }

    .footer {
      text-align: center;
      color: var(--muted);
      font-size: 12px;
      padding-bottom: 2px;
    }

    .hidden { display: none !important; }

    .flash-good { color: var(--good); font-weight: 800; }
    .flash-bad { color: var(--bad); font-weight: 800; }

    /* Streak indicator */
    .streak {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: var(--warn);
      font-weight: 700;
    }
    .streak.hidden { display: none; }

    /* Coins display */
    .coins-display {
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--coin);
      font-weight: 700;
    }
    .coin-icon {
      width: 20px;
      height: 20px;
    }
    .coin-change {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 32px;
      font-weight: 900;
      pointer-events: none;
      animation: coinPop 0.6s ease-out forwards;
      z-index: 100;
    }
    .coin-change.positive { color: var(--coin); }
    .coin-change.negative { color: var(--bad); }
    @keyframes coinPop {
      0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      100% { opacity: 0; transform: translate(-50%, -100%) scale(1.3); }
    }

    /* Character display */
    .character-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
    }
    .character-container {
      width: 120px;
      height: 150px;
      position: relative;
    }
    .character-name {
      margin-top: 8px;
      font-size: 14px;
      color: var(--muted);
    }

    /* Stats page styles */
    .stats-section {
      margin-top: 14px;
    }
    .stats-section h3 {
      font-size: 14px;
      color: var(--muted);
      margin: 0 0 10px 0;
      font-weight: 600;
    }
    .attempt-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: rgba(255,255,255,0.04);
      border-radius: 10px;
      margin-bottom: 8px;
    }
    .attempt-row .date { color: var(--muted); font-size: 13px; }
    .attempt-row .score { font-weight: 700; font-size: 16px; }
    .attempt-row .details { font-size: 12px; color: var(--muted); }

    .trouble-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: rgba(251,113,133,0.1);
      border: 1px solid rgba(251,113,133,0.2);
      border-radius: 10px;
      margin-bottom: 8px;
    }
    .trouble-row .fact { font-weight: 700; font-size: 16px; }
    .trouble-row .stat { font-size: 13px; color: var(--bad); }

    .no-data {
      text-align: center;
      color: var(--muted);
      padding: 20px;
      font-size: 14px;
    }

    .tab-bar {
      display: flex;
      gap: 8px;
      margin-bottom: 14px;
    }
    .tab-bar button {
      flex: 1;
      padding: 10px;
      font-size: 14px;
      font-weight: 600;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      color: var(--muted);
      cursor: pointer;
      touch-action: manipulation;
    }
    .tab-bar button.active {
      background: rgba(45,212,191,0.15);
      border-color: rgba(45,212,191,0.3);
      color: var(--good);
    }
    .tab-bar button:hover:not(.active) {
      background: rgba(255,255,255,0.08);
    }

    /* Time mode selector */
    .time-modes {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-bottom: 12px;
    }
    .time-modes button {
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      color: var(--muted);
      cursor: pointer;
      touch-action: manipulation;
    }
    .time-modes button.active {
      background: rgba(45,212,191,0.15);
      border-color: rgba(45,212,191,0.3);
      color: var(--good);
    }

    /* Shop styles */
    .shop-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 14px;
    }
    .shop-item {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 14px;
      padding: 14px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      touch-action: manipulation;
    }
    .shop-item:hover {
      background: rgba(255,255,255,0.08);
    }
    .shop-item.owned {
      border-color: rgba(45,212,191,0.4);
      background: rgba(45,212,191,0.1);
    }
    .shop-item.equipped {
      border-color: var(--coin);
      background: rgba(252,211,77,0.15);
    }
    .shop-item-preview {
      width: 60px;
      height: 75px;
      margin: 0 auto 8px;
    }
    .shop-item-name {
      font-weight: 700;
      font-size: 14px;
      margin-bottom: 4px;
    }
    .shop-item-price {
      font-size: 13px;
      color: var(--coin);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }
    .shop-item-price.owned {
      color: var(--good);
    }

    @media (min-width: 640px) {
      .grid { grid-template-columns: repeat(3, 1fr); }
      .shop-grid { grid-template-columns: repeat(3, 1fr); }
    }
  </style>
</head>
<body>
  <div class="wrap" role="application" aria-label="Number Ninja">
    <div class="topbar">
      <div class="pill" aria-live="polite">
        <div>
          <div class="label">Time left</div>
          <div class="value" id="timeLeft">1:00</div>
        </div>
        <div style="text-align:right">
          <div class="label">Round</div>
          <div class="value" id="round">0</div>
        </div>
      </div>
      <div class="pill" aria-live="polite">
        <div>
          <div class="label">Score</div>
          <div class="value"><span id="score">0</span> <span class="streak hidden" id="streak"></span></div>
        </div>
        <div style="text-align:right">
          <div class="label">Coins</div>
          <div class="value coins-display">
            <svg class="coin-icon" viewBox="0 0 24 24" fill="currentColor">
              <circle cx="12" cy="12" r="10" fill="#fcd34d"/>
              <circle cx="12" cy="12" r="7" fill="#fbbf24"/>
              <text x="12" y="16" text-anchor="middle" font-size="10" font-weight="bold" fill="#92400e">$</text>
            </svg>
            <span id="coins">0</span>
          </div>
        </div>
      </div>
    </div>

    <div class="card" id="gameCard">
      <div class="character-area">
        <div class="character-container" id="characterDisplay"></div>
      </div>

      <div class="question" id="question">Press Start</div>
      <div class="sub" id="status">Answer as many as you can!</div>

      <div class="time-modes" id="timeModes">
        <button data-time="30">30s</button>
        <button data-time="60" class="active">1 min</button>
        <button data-time="120">2 min</button>
      </div>

      <div class="grid" id="choices"></div>

      <div class="controls">
        <button class="primary" id="startBtn">Start</button>
        <button class="secondary" id="restartBtn" disabled>Stop</button>
        <button class="secondary" id="shopBtn">Shop</button>
        <button class="secondary" id="statsBtn">Stats</button>
      </div>
    </div>

    <div class="card hidden" id="shopCard">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <div style="font-size:18px; font-weight:900;">Shop</div>
        <div class="coins-display">
          <svg class="coin-icon" viewBox="0 0 24 24" fill="currentColor">
            <circle cx="12" cy="12" r="10" fill="#fcd34d"/>
            <circle cx="12" cy="12" r="7" fill="#fbbf24"/>
            <text x="12" y="16" text-anchor="middle" font-size="10" font-weight="bold" fill="#92400e">$</text>
          </svg>
          <span id="shopCoins">0</span>
        </div>
        <button class="secondary" id="closeShopBtn">Close</button>
      </div>

      <div class="shop-grid" id="shopGrid"></div>

      <div class="footer" style="margin-top:14px;">
        +10 coins for correct answers, -5 for wrong
      </div>
    </div>

    <div class="card hidden" id="settingsCard">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <div style="font-size:18px; font-weight:900;">Settings</div>
        <button class="secondary" id="closeSettingsBtn">Close</button>
      </div>

      <div style="display:grid; gap:12px; margin-top:12px;">
        <label style="display:grid; gap:6px;">
          <span style="color:var(--muted); font-size:13px;">Tables (choose range)</span>
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div class="pill" style="box-shadow:none; background:rgba(255,255,255,0.04);">
              <div>
                <div class="label">Min</div>
                <div class="value">
                  <select id="minTable" style="font-size:16px; padding:6px 8px; border-radius:10px; border:1px solid rgba(255,255,255,0.15); background:#0f1830; color:var(--text);"></select>
                </div>
              </div>
            </div>
            <div class="pill" style="box-shadow:none; background:rgba(255,255,255,0.04);">
              <div>
                <div class="label">Max</div>
                <div class="value">
                  <select id="maxTable" style="font-size:16px; padding:6px 8px; border-radius:10px; border:1px solid rgba(255,255,255,0.15); background:#0f1830; color:var(--text);"></select>
                </div>
              </div>
            </div>
          </div>
        </label>

        <label style="display:grid; gap:6px;">
          <span style="color:var(--muted); font-size:13px;">Multipliers (numbers you multiply by)</span>
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div class="pill" style="box-shadow:none; background:rgba(255,255,255,0.04);">
              <div>
                <div class="label">Min</div>
                <div class="value">
                  <select id="minMul" style="font-size:16px; padding:6px 8px; border-radius:10px; border:1px solid rgba(255,255,255,0.15); background:#0f1830; color:var(--text);"></select>
                </div>
              </div>
            </div>
            <div class="pill" style="box-shadow:none; background:rgba(255,255,255,0.04);">
              <div>
                <div class="label">Max</div>
                <div class="value">
                  <select id="maxMul" style="font-size:16px; padding:6px 8px; border-radius:10px; border:1px solid rgba(255,255,255,0.15); background:#0f1830; color:var(--text);"></select>
                </div>
              </div>
            </div>
          </div>
        </label>

        <button class="secondary" id="clearDataBtn" style="margin-top:10px; color:var(--bad); border-color:rgba(251,113,133,0.3);">Clear All Data</button>

        <div class="footer">
          Tip: for an 8 year old, try tables 2-12 and multipliers 2-12.
        </div>
      </div>
    </div>

    <div class="card hidden" id="statsCard">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <div style="font-size:18px; font-weight:900;">Stats</div>
        <button class="secondary" id="closeStatsBtn">Close</button>
      </div>

      <div class="tab-bar">
        <button class="active" data-tab="history">Recent Games</button>
        <button data-tab="trouble">Trouble Spots</button>
      </div>

      <div id="historyTab">
        <div class="stats-section">
          <h3>Last 5 Attempts</h3>
          <div id="historyList"></div>
        </div>
      </div>

      <div id="troubleTab" class="hidden">
        <div class="stats-section">
          <h3>Most Missed (from last 5 games)</h3>
          <div id="troubleList"></div>
        </div>
      </div>
    </div>

    <div class="controls" style="justify-content:center;">
      <button class="secondary" id="settingsBtn">Settings</button>
    </div>

    <div class="footer">Tap answers. Works offline once saved.</div>
  </div>

  <script>
    // ---------- Utilities ----------
    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // ---------- Shop Items ----------
    const SHOP_ITEMS = [
      { id: "default", name: "Plain", price: 0, owned: true, skinColor: "#fcd5ce", shirtColor: "#6b7280", pantsColor: "#374151", hatColor: null, accessory: null },
      { id: "football", name: "Football Kit", price: 50, owned: false, skinColor: "#fcd5ce", shirtColor: "#dc2626", pantsColor: "#ffffff", hatColor: null, accessory: "football" },
      { id: "cricket", name: "Cricket Kit", price: 50, owned: false, skinColor: "#fcd5ce", shirtColor: "#f5f5f4", pantsColor: "#f5f5f4", hatColor: "#1e3a5f", accessory: "bat" },
      { id: "ninja", name: "Ninja", price: 100, owned: false, skinColor: "#fcd5ce", shirtColor: "#1f2937", pantsColor: "#1f2937", hatColor: "#1f2937", accessory: "mask" },
      { id: "wizard", name: "Wizard", price: 100, owned: false, skinColor: "#fcd5ce", shirtColor: "#7c3aed", pantsColor: "#5b21b6", hatColor: "#7c3aed", accessory: "wand" },
      { id: "superhero", name: "Superhero", price: 150, owned: false, skinColor: "#fcd5ce", shirtColor: "#2563eb", pantsColor: "#1d4ed8", hatColor: null, accessory: "cape" },
      { id: "pirate", name: "Pirate", price: 150, owned: false, skinColor: "#fcd5ce", shirtColor: "#92400e", pantsColor: "#1f2937", hatColor: "#1f2937", accessory: "eyepatch" },
      { id: "astronaut", name: "Astronaut", price: 200, owned: false, skinColor: "#fcd5ce", shirtColor: "#f5f5f4", pantsColor: "#f5f5f4", hatColor: "#f5f5f4", accessory: "helmet" },
      { id: "robot", name: "Robot", price: 250, owned: false, skinColor: "#9ca3af", shirtColor: "#6b7280", pantsColor: "#4b5563", hatColor: "#6b7280", accessory: "antenna" },
    ];

    // ---------- State ----------
    const state = {
      running: false,
      durationSec: 60,
      timeLeft: 60,
      score: 0,
      round: 0,
      streak: 0,
      a: 0,
      b: 0,
      correct: 0,
      best: 0,
      coins: 0,
      timerId: null,
      currentResults: [],
      minTable: 2,
      maxTable: 12,
      minMul: 2,
      maxMul: 12,
      ownedItems: ["default"],
      equippedItem: "default",
    };

    // ---------- Storage Keys ----------
    const BEST_KEY = "tt_best_score_v2";
    const HISTORY_KEY = "tt_history_v1";
    const SETTINGS_KEY = "tt_settings_v1";
    const COINS_KEY = "tt_coins_v1";
    const SHOP_KEY = "tt_shop_v1";

    // ---------- Elements ----------
    const elQuestion = document.getElementById("question");
    const elStatus = document.getElementById("status");
    const elChoices = document.getElementById("choices");
    const elTimeLeft = document.getElementById("timeLeft");
    const elScore = document.getElementById("score");
    const elRound = document.getElementById("round");
    const elBest = document.getElementById("best");
    const elStreak = document.getElementById("streak");
    const elCoins = document.getElementById("coins");
    const elShopCoins = document.getElementById("shopCoins");
    const elCharacterDisplay = document.getElementById("characterDisplay");

    const startBtn = document.getElementById("startBtn");
    const restartBtn = document.getElementById("restartBtn");
    const settingsBtn = document.getElementById("settingsBtn");
    const statsBtn = document.getElementById("statsBtn");
    const shopBtn = document.getElementById("shopBtn");

    const gameCard = document.getElementById("gameCard");
    const settingsCard = document.getElementById("settingsCard");
    const statsCard = document.getElementById("statsCard");
    const shopCard = document.getElementById("shopCard");
    const closeSettingsBtn = document.getElementById("closeSettingsBtn");
    const closeStatsBtn = document.getElementById("closeStatsBtn");
    const closeShopBtn = document.getElementById("closeShopBtn");
    const clearDataBtn = document.getElementById("clearDataBtn");

    const minTableSel = document.getElementById("minTable");
    const maxTableSel = document.getElementById("maxTable");
    const minMulSel = document.getElementById("minMul");
    const maxMulSel = document.getElementById("maxMul");

    const timeModes = document.getElementById("timeModes");
    const historyList = document.getElementById("historyList");
    const troubleList = document.getElementById("troubleList");
    const historyTab = document.getElementById("historyTab");
    const troubleTab = document.getElementById("troubleTab");
    const shopGrid = document.getElementById("shopGrid");

    // ---------- Character SVG Generator ----------
    function generateCharacterSVG(item, size = 1) {
      const w = 120 * size;
      const h = 150 * size;
      const scale = size;

      let accessoryHTML = "";

      // Accessories
      if (item.accessory === "football") {
        accessoryHTML = `<ellipse cx="${60*scale}" cy="${130*scale}" rx="${12*scale}" ry="${8*scale}" fill="#1f2937" stroke="#fff" stroke-width="1"/>`;
      } else if (item.accessory === "bat") {
        accessoryHTML = `<rect x="${95*scale}" y="${70*scale}" width="${6*scale}" height="${45*scale}" rx="2" fill="#92400e"/><rect x="${93*scale}" y="${65*scale}" width="${10*scale}" height="${8*scale}" rx="2" fill="#a16207"/>`;
      } else if (item.accessory === "mask") {
        accessoryHTML = `<rect x="${35*scale}" y="${28*scale}" width="${50*scale}" height="${12*scale}" rx="2" fill="#1f2937"/><rect x="${42*scale}" y="${30*scale}" width="${10*scale}" height="${6*scale}" fill="#0b1220"/><rect x="${68*scale}" y="${30*scale}" width="${10*scale}" height="${6*scale}" fill="#0b1220"/>`;
      } else if (item.accessory === "wand") {
        accessoryHTML = `<rect x="${95*scale}" y="${60*scale}" width="${4*scale}" height="${35*scale}" fill="#92400e"/><polygon points="${97*scale},${55*scale} ${92*scale},${65*scale} ${102*scale},${65*scale}" fill="#fcd34d"/>`;
      } else if (item.accessory === "cape") {
        accessoryHTML = `<path d="M${40*scale},${55*scale} Q${30*scale},${90*scale} ${35*scale},${120*scale} L${85*scale},${120*scale} Q${90*scale},${90*scale} ${80*scale},${55*scale}" fill="#dc2626" opacity="0.9"/>`;
      } else if (item.accessory === "eyepatch") {
        accessoryHTML = `<ellipse cx="${48*scale}" cy="${32*scale}" rx="${8*scale}" ry="${6*scale}" fill="#1f2937"/><line x1="${40*scale}" y1="${28*scale}" x2="${80*scale}" y2="${22*scale}" stroke="#1f2937" stroke-width="2"/>`;
      } else if (item.accessory === "helmet") {
        accessoryHTML = `<ellipse cx="${60*scale}" cy="${25*scale}" rx="${28*scale}" ry="${22*scale}" fill="#f5f5f4" stroke="#9ca3af" stroke-width="2"/><rect x="${38*scale}" y="${28*scale}" width="${44*scale}" height="${16*scale}" rx="4" fill="#87ceeb" opacity="0.6"/>`;
      } else if (item.accessory === "antenna") {
        accessoryHTML = `<line x1="${60*scale}" y1="${8*scale}" x2="${60*scale}" y2="${0*scale}" stroke="#6b7280" stroke-width="3"/><circle cx="${60*scale}" cy="${0*scale}" r="${4*scale}" fill="#ef4444"/>`;
      }

      // Hat
      let hatHTML = "";
      if (item.hatColor && item.accessory !== "helmet") {
        if (item.accessory === "mask") {
          // Ninja headband already covered
        } else if (item.id === "cricket") {
          hatHTML = `<ellipse cx="${60*scale}" cy="${12*scale}" rx="${22*scale}" ry="${8*scale}" fill="${item.hatColor}"/><ellipse cx="${60*scale}" cy="${8*scale}" rx="${18*scale}" ry="${10*scale}" fill="${item.hatColor}"/>`;
        } else if (item.id === "wizard") {
          hatHTML = `<polygon points="${60*scale},${-5*scale} ${35*scale},${20*scale} ${85*scale},${20*scale}" fill="${item.hatColor}"/><ellipse cx="${60*scale}" cy="${20*scale}" rx="${28*scale}" ry="${6*scale}" fill="${item.hatColor}"/>`;
        } else if (item.id === "pirate") {
          hatHTML = `<ellipse cx="${60*scale}" cy="${12*scale}" rx="${28*scale}" ry="${8*scale}" fill="${item.hatColor}"/><path d="M${32*scale},${12*scale} Q${60*scale},${-10*scale} ${88*scale},${12*scale}" fill="${item.hatColor}"/><path d="M${50*scale},${5*scale} L${55*scale},${-2*scale} L${65*scale},${-2*scale} L${70*scale},${5*scale}" fill="#f5f5f4"/>`;
        } else {
          hatHTML = `<ellipse cx="${60*scale}" cy="${15*scale}" rx="${24*scale}" ry="${12*scale}" fill="${item.hatColor}"/>`;
        }
      }

      return `
        <svg viewBox="0 0 ${w} ${h}" width="${w}" height="${h}">
          <!-- Cape goes behind -->
          ${item.accessory === "cape" ? accessoryHTML : ""}

          <!-- Body -->
          <rect x="${40*scale}" y="${55*scale}" width="${40*scale}" height="${45*scale}" rx="8" fill="${item.shirtColor}"/>

          <!-- Legs -->
          <rect x="${42*scale}" y="${95*scale}" width="${15*scale}" height="${40*scale}" rx="4" fill="${item.pantsColor}"/>
          <rect x="${63*scale}" y="${95*scale}" width="${15*scale}" height="${40*scale}" rx="4" fill="${item.pantsColor}"/>

          <!-- Shoes -->
          <ellipse cx="${50*scale}" cy="${138*scale}" rx="${10*scale}" ry="${6*scale}" fill="#1f2937"/>
          <ellipse cx="${70*scale}" cy="${138*scale}" rx="${10*scale}" ry="${6*scale}" fill="#1f2937"/>

          <!-- Arms -->
          <rect x="${25*scale}" y="${58*scale}" width="${18*scale}" height="${10*scale}" rx="4" fill="${item.shirtColor}"/>
          <rect x="${77*scale}" y="${58*scale}" width="${18*scale}" height="${10*scale}" rx="4" fill="${item.shirtColor}"/>

          <!-- Hands -->
          <circle cx="${25*scale}" cy="${63*scale}" r="${6*scale}" fill="${item.skinColor}"/>
          <circle cx="${95*scale}" cy="${63*scale}" r="${6*scale}" fill="${item.skinColor}"/>

          <!-- Head -->
          <ellipse cx="${60*scale}" cy="${30*scale}" rx="${22*scale}" ry="${24*scale}" fill="${item.skinColor}"/>

          <!-- Eyes -->
          <circle cx="${52*scale}" cy="${30*scale}" r="${4*scale}" fill="#1f2937"/>
          <circle cx="${68*scale}" cy="${30*scale}" r="${4*scale}" fill="#1f2937"/>
          <circle cx="${53*scale}" cy="${29*scale}" r="${1.5*scale}" fill="#fff"/>
          <circle cx="${69*scale}" cy="${29*scale}" r="${1.5*scale}" fill="#fff"/>

          <!-- Smile -->
          <path d="M${50*scale},${40*scale} Q${60*scale},${48*scale} ${70*scale},${40*scale}" stroke="#1f2937" stroke-width="2" fill="none" stroke-linecap="round"/>

          <!-- Hair/Hat -->
          ${hatHTML}

          <!-- Accessories (except cape) -->
          ${item.accessory !== "cape" ? accessoryHTML : ""}
        </svg>
      `;
    }

    function renderCharacter() {
      const item = SHOP_ITEMS.find(i => i.id === state.equippedItem) || SHOP_ITEMS[0];
      elCharacterDisplay.innerHTML = generateCharacterSVG(item);
    }

    // ---------- Coins ----------
    function loadCoins() {
      const saved = Number(localStorage.getItem(COINS_KEY));
      state.coins = Number.isFinite(saved) ? saved : 0;
      updateCoinsDisplay();
    }

    function saveCoins() {
      localStorage.setItem(COINS_KEY, String(state.coins));
      updateCoinsDisplay();
    }

    function updateCoinsDisplay() {
      elCoins.textContent = String(state.coins);
      elShopCoins.textContent = String(state.coins);
    }

    function addCoins(amount) {
      state.coins = Math.max(0, state.coins + amount);
      saveCoins();

      // Show floating coin indicator
      const el = document.createElement("div");
      el.className = `coin-change ${amount >= 0 ? "positive" : "negative"}`;
      el.textContent = amount >= 0 ? `+${amount}` : String(amount);
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 600);
    }

    // ---------- Shop Storage ----------
    function loadShopData() {
      try {
        const data = localStorage.getItem(SHOP_KEY);
        if (data) {
          const s = JSON.parse(data);
          state.ownedItems = s.owned || ["default"];
          state.equippedItem = s.equipped || "default";
        }
      } catch {}
      renderCharacter();
    }

    function saveShopData() {
      localStorage.setItem(SHOP_KEY, JSON.stringify({
        owned: state.ownedItems,
        equipped: state.equippedItem,
      }));
    }

    // ---------- Shop UI ----------
    function renderShop() {
      shopGrid.innerHTML = SHOP_ITEMS.map(item => {
        const owned = state.ownedItems.includes(item.id);
        const equipped = state.equippedItem === item.id;
        const canAfford = state.coins >= item.price;

        return `
          <div class="shop-item ${owned ? "owned" : ""} ${equipped ? "equipped" : ""}" data-id="${item.id}">
            <div class="shop-item-preview">
              ${generateCharacterSVG(item, 0.5)}
            </div>
            <div class="shop-item-name">${item.name}</div>
            <div class="shop-item-price ${owned ? "owned" : ""}" style="${!owned && !canAfford ? "opacity:0.5" : ""}">
              ${equipped ? "Equipped" : owned ? "Owned - Tap to wear" : `
                <svg class="coin-icon" style="width:14px;height:14px;" viewBox="0 0 24 24">
                  <circle cx="12" cy="12" r="10" fill="#fcd34d"/>
                  <circle cx="12" cy="12" r="7" fill="#fbbf24"/>
                  <text x="12" y="16" text-anchor="middle" font-size="10" font-weight="bold" fill="#92400e">$</text>
                </svg>
                ${item.price}
              `}
            </div>
          </div>
        `;
      }).join("");

      // Add click handlers
      shopGrid.querySelectorAll(".shop-item").forEach(el => {
        el.addEventListener("click", () => handleShopItemClick(el.dataset.id));
      });
    }

    function handleShopItemClick(itemId) {
      const item = SHOP_ITEMS.find(i => i.id === itemId);
      if (!item) return;

      const owned = state.ownedItems.includes(itemId);

      if (owned) {
        // Equip it
        state.equippedItem = itemId;
        saveShopData();
        renderShop();
        renderCharacter();
      } else if (state.coins >= item.price) {
        // Buy it
        state.coins -= item.price;
        state.ownedItems.push(itemId);
        state.equippedItem = itemId;
        saveCoins();
        saveShopData();
        renderShop();
        renderCharacter();
      }
    }

    function openShop() {
      shopCard.classList.remove("hidden");
      settingsCard.classList.add("hidden");
      statsCard.classList.add("hidden");
      renderShop();
      shopCard.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    function closeShop() {
      shopCard.classList.add("hidden");
      gameCard.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    // ---------- History Storage ----------
    function loadHistory() {
      try {
        const data = localStorage.getItem(HISTORY_KEY);
        return data ? JSON.parse(data) : [];
      } catch {
        return [];
      }
    }

    function saveHistory(history) {
      const trimmed = history.slice(-5);
      localStorage.setItem(HISTORY_KEY, JSON.stringify(trimmed));
    }

    function addGameToHistory(gameData) {
      const history = loadHistory();
      history.push(gameData);
      saveHistory(history);
    }

    // ---------- Settings Storage ----------
    function loadSettings() {
      try {
        const data = localStorage.getItem(SETTINGS_KEY);
        if (data) {
          const s = JSON.parse(data);
          state.minTable = s.minTable ?? 2;
          state.maxTable = s.maxTable ?? 12;
          state.minMul = s.minMul ?? 2;
          state.maxMul = s.maxMul ?? 12;
          state.durationSec = s.durationSec ?? 60;
        }
      } catch {}
    }

    function saveSettings() {
      localStorage.setItem(SETTINGS_KEY, JSON.stringify({
        minTable: state.minTable,
        maxTable: state.maxTable,
        minMul: state.minMul,
        maxMul: state.maxMul,
        durationSec: state.durationSec,
      }));
    }

    // ---------- Best score ----------
    function loadBest() {
      const saved = Number(localStorage.getItem(BEST_KEY));
      state.best = Number.isFinite(saved) ? saved : 0;
    }
    function saveBestIfNeeded() {
      if (state.score > state.best) {
        state.best = state.score;
        localStorage.setItem(BEST_KEY, String(state.best));
      }
    }

    // ---------- UI updates ----------
    function formatTime(sec) {
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `${m}:${String(s).padStart(2, "0")}`;
    }
    function setTime(sec) {
      elTimeLeft.textContent = formatTime(sec);
    }
    function setStatus(msg, cls) {
      elStatus.className = "sub";
      if (cls) elStatus.classList.add(cls);
      elStatus.textContent = msg;
    }
    function setScore(val) { elScore.textContent = String(val); }
    function setRound(val) { elRound.textContent = String(val); }

    function updateStreak() {
      if (state.streak >= 3) {
        elStreak.textContent = `${state.streak}x`;
        elStreak.classList.remove("hidden");
      } else {
        elStreak.classList.add("hidden");
      }
    }

    function setButtons() {
      startBtn.disabled = state.running;
      restartBtn.disabled = !state.running;
      settingsBtn.disabled = state.running;
      statsBtn.disabled = state.running;
      shopBtn.disabled = state.running;
      timeModes.style.display = state.running ? "none" : "flex";
    }

    // ---------- Settings ----------
    function fillSelect(sel, min, max, value) {
      sel.innerHTML = "";
      for (let i = min; i <= max; i++) {
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = String(i);
        if (i === value) opt.selected = true;
        sel.appendChild(opt);
      }
    }

    function initSettingsUI() {
      fillSelect(minTableSel, 1, 20, state.minTable);
      fillSelect(maxTableSel, 1, 20, state.maxTable);
      fillSelect(minMulSel, 1, 20, state.minMul);
      fillSelect(maxMulSel, 1, 20, state.maxMul);

      function clampRanges() {
        const minT = Number(minTableSel.value);
        const maxT = Number(maxTableSel.value);
        const minM = Number(minMulSel.value);
        const maxM = Number(maxMulSel.value);

        if (minT > maxT) maxTableSel.value = String(minT);
        if (minM > maxM) maxMulSel.value = String(minM);

        state.minTable = Number(minTableSel.value);
        state.maxTable = Number(maxTableSel.value);
        state.minMul = Number(minMulSel.value);
        state.maxMul = Number(maxMulSel.value);
        saveSettings();
      }

      minTableSel.addEventListener("change", clampRanges);
      maxTableSel.addEventListener("change", clampRanges);
      minMulSel.addEventListener("change", clampRanges);
      maxMulSel.addEventListener("change", clampRanges);
    }

    function initTimeModes() {
      const btns = timeModes.querySelectorAll("button");
      btns.forEach(btn => {
        if (Number(btn.dataset.time) === state.durationSec) {
          btn.classList.add("active");
        } else {
          btn.classList.remove("active");
        }
        btn.addEventListener("click", () => {
          btns.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          state.durationSec = Number(btn.dataset.time);
          state.timeLeft = state.durationSec;
          setTime(state.timeLeft);
          saveSettings();
        });
      });
    }

    function openSettings() {
      settingsCard.classList.remove("hidden");
      statsCard.classList.add("hidden");
      shopCard.classList.add("hidden");
      settingsCard.scrollIntoView({ behavior: "smooth", block: "start" });
    }
    function closeSettings() {
      settingsCard.classList.add("hidden");
      gameCard.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    // ---------- Stats Page ----------
    function openStats() {
      statsCard.classList.remove("hidden");
      settingsCard.classList.add("hidden");
      shopCard.classList.add("hidden");
      renderStats();
      statsCard.scrollIntoView({ behavior: "smooth", block: "start" });
    }
    function closeStats() {
      statsCard.classList.add("hidden");
      gameCard.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    function renderStats() {
      const history = loadHistory();

      if (history.length === 0) {
        historyList.innerHTML = '<div class="no-data">No games played yet. Start playing!</div>';
      } else {
        historyList.innerHTML = history.slice().reverse().map(game => {
          const date = new Date(game.timestamp);
          const dateStr = date.toLocaleDateString(undefined, { month: "short", day: "numeric" });
          const timeStr = date.toLocaleTimeString(undefined, { hour: "2-digit", minute: "2-digit" });
          const correct = game.results.filter(r => r.correct).length;
          const total = game.results.length;
          const pct = total > 0 ? Math.round((correct / total) * 100) : 0;
          return `
            <div class="attempt-row">
              <div>
                <div class="date">${dateStr} ${timeStr}</div>
                <div class="details">${game.duration}s | Tables ${game.settings.minTable}-${game.settings.maxTable}</div>
              </div>
              <div style="text-align:right">
                <div class="score">${game.score}</div>
                <div class="details">${correct}/${total} (${pct}%)</div>
              </div>
            </div>
          `;
        }).join("");
      }

      const mistakes = {};
      history.forEach(game => {
        game.results.forEach(r => {
          const key = `${r.a}x${r.b}`;
          if (!mistakes[key]) {
            mistakes[key] = { a: r.a, b: r.b, wrong: 0, total: 0 };
          }
          mistakes[key].total++;
          if (!r.correct) mistakes[key].wrong++;
        });
      });

      const troubleSpots = Object.values(mistakes)
        .filter(m => m.wrong > 0)
        .sort((a, b) => {
          const rateA = a.wrong / a.total;
          const rateB = b.wrong / b.total;
          if (rateB !== rateA) return rateB - rateA;
          return b.wrong - a.wrong;
        })
        .slice(0, 8);

      if (troubleSpots.length === 0) {
        troubleList.innerHTML = '<div class="no-data">No mistakes found. Keep it up!</div>';
      } else {
        troubleList.innerHTML = troubleSpots.map(m => {
          const pct = Math.round((m.wrong / m.total) * 100);
          return `
            <div class="trouble-row">
              <div class="fact">${m.a} x ${m.b} = ${m.a * m.b}</div>
              <div class="stat">${m.wrong}/${m.total} wrong (${pct}%)</div>
            </div>
          `;
        }).join("");
      }
    }

    // Tab switching
    document.querySelectorAll(".tab-bar button").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tab-bar button").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        if (btn.dataset.tab === "history") {
          historyTab.classList.remove("hidden");
          troubleTab.classList.add("hidden");
        } else {
          historyTab.classList.add("hidden");
          troubleTab.classList.remove("hidden");
        }
      });
    });

    // ---------- Tricky Answer Generation ----------
    function generateTrickyChoices(a, b, correct) {
      const answers = new Set();
      answers.add(correct);

      const patterns = [
        () => correct + 1,
        () => correct - 1,
        () => correct + a,
        () => correct - a,
        () => correct + b,
        () => correct - b,
        () => (a + 1) * b,
        () => (a - 1) * b,
        () => a * (b + 1),
        () => a * (b - 1),
        () => {
          if (correct >= 10 && correct < 100) {
            const tens = Math.floor(correct / 10);
            const ones = correct % 10;
            if (tens !== ones) return ones * 10 + tens;
          }
          return correct + randInt(2, 5);
        },
        () => a + b + randInt(5, 15),
        () => Math.round(correct * (1 + (randInt(1, 2) * 0.1 * (Math.random() > 0.5 ? 1 : -1)))),
        () => {
          if (correct >= 10) {
            const tens = Math.floor(correct / 10) * 10;
            return tens + randInt(0, 9);
          }
          return correct + randInt(2, 8);
        },
      ];

      const shuffledPatterns = shuffle([...patterns]);
      let attempts = 0;
      const maxAttempts = 50;

      while (answers.size < 6 && attempts < maxAttempts) {
        attempts++;
        const patternFn = shuffledPatterns[attempts % shuffledPatterns.length];
        const candidate = patternFn();

        if (
          candidate > 0 &&
          candidate !== correct &&
          candidate <= Math.max(correct * 1.5, correct + 20) &&
          candidate >= Math.max(1, correct * 0.5, correct - 20)
        ) {
          answers.add(candidate);
        }
      }

      let offset = 2;
      while (answers.size < 6) {
        const candidate = correct + offset;
        if (candidate > 0) answers.add(candidate);
        offset = offset > 0 ? -offset : -offset + 1;
      }

      return shuffle([...answers].slice(0, 6));
    }

    // ---------- Game logic ----------
    function makeQuestion() {
      state.a = randInt(state.minTable, state.maxTable);
      state.b = randInt(state.minMul, state.maxMul);
      state.correct = state.a * state.b;
      elQuestion.textContent = `${state.a} x ${state.b} = ?`;
    }

    function makeChoices() {
      const choices = generateTrickyChoices(state.a, state.b, state.correct);

      elChoices.innerHTML = "";
      choices.forEach((val) => {
        const btn = document.createElement("button");
        btn.className = "choice";
        btn.type = "button";
        btn.textContent = String(val);
        btn.addEventListener("click", () => handleAnswer(val));
        elChoices.appendChild(btn);
      });
    }

    function nextRound() {
      state.round += 1;
      setRound(state.round);
      makeQuestion();
      makeChoices();
    }

    function handleAnswer(val) {
      if (!state.running) return;

      const isCorrect = val === state.correct;

      state.currentResults.push({
        a: state.a,
        b: state.b,
        answer: val,
        correctAnswer: state.correct,
        correct: isCorrect,
      });

      if (isCorrect) {
        state.score += 1;
        state.streak += 1;
        setScore(state.score);
        updateStreak();
        addCoins(10);
        if (state.streak >= 5) {
          setStatus(`${state.streak} in a row! +10`, "flash-good");
        } else {
          setStatus("Nice! +10", "flash-good");
        }
      } else {
        state.streak = 0;
        updateStreak();
        addCoins(-5);
        setStatus(`Oops! It was ${state.correct}. -5`, "flash-bad");
      }

      nextRound();
    }

    function tick() {
      state.timeLeft -= 1;
      setTime(state.timeLeft);

      if (state.timeLeft <= 0) {
        endGame();
      }
    }

    function startGame() {
      state.running = true;
      state.score = 0;
      state.round = 0;
      state.streak = 0;
      state.timeLeft = state.durationSec;
      state.currentResults = [];

      setScore(state.score);
      setRound(state.round);
      setTime(state.timeLeft);
      setStatus("Go go go!", "");
      updateStreak();

      setButtons();
      closeSettings();
      closeStats();
      closeShop();

      nextRound();

      clearInterval(state.timerId);
      state.timerId = setInterval(tick, 1000);
    }

    function endGame() {
      state.running = false;
      clearInterval(state.timerId);
      state.timerId = null;

      addGameToHistory({
        timestamp: Date.now(),
        score: state.score,
        duration: state.durationSec,
        settings: {
          minTable: state.minTable,
          maxTable: state.maxTable,
          minMul: state.minMul,
          maxMul: state.maxMul,
        },
        results: state.currentResults,
      });

      saveBestIfNeeded();
      setButtons();

      const correct = state.currentResults.filter(r => r.correct).length;
      const total = state.currentResults.length;
      const coinsEarned = (correct * 10) - ((total - correct) * 5);
      elQuestion.textContent = `Done! ${state.score}`;
      setStatus(`${correct}/${total} correct. ${coinsEarned >= 0 ? "+" : ""}${coinsEarned} coins`, "");
      elChoices.innerHTML = "";
      state.streak = 0;
      updateStreak();
    }

    // ---------- Wire up ----------
    startBtn.addEventListener("click", startGame);
    restartBtn.addEventListener("click", endGame);
    settingsBtn.addEventListener("click", openSettings);
    closeSettingsBtn.addEventListener("click", closeSettings);
    statsBtn.addEventListener("click", openStats);
    closeStatsBtn.addEventListener("click", closeStats);
    shopBtn.addEventListener("click", openShop);
    closeShopBtn.addEventListener("click", closeShop);

    clearDataBtn.addEventListener("click", () => {
      if (confirm("Clear all game history, coins, and purchases?")) {
        localStorage.removeItem(HISTORY_KEY);
        localStorage.removeItem(BEST_KEY);
        localStorage.removeItem(COINS_KEY);
        localStorage.removeItem(SHOP_KEY);
        state.best = 0;
        state.coins = 0;
        state.ownedItems = ["default"];
        state.equippedItem = "default";
        updateCoinsDisplay();
        renderStats();
        renderShop();
        renderCharacter();
        alert("Data cleared!");
      }
    });

    // Init
    loadSettings();
    loadBest();
    loadCoins();
    loadShopData();
    initSettingsUI();
    initTimeModes();
    state.timeLeft = state.durationSec;
    setTime(state.timeLeft);
    setButtons();
    renderCharacter();
  </script>
</body>
</html>
